name: CI

# Note: macOS runners require either:
# - Public repository (free)
# - GitHub Team/Enterprise plan (paid)
# - Self-hosted runners

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    name: Build & Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Swift packages
        uses: actions/cache@v5
        with:
          path: .build
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Build
        run: make build

      - name: Test (Debug)
        run: swift test --enable-code-coverage

      - name: Test (Release)
        run: swift test -c release

      - name: Verify Launch
        run: |
          chmod +x scripts/verify-launch.sh
          ./scripts/verify-launch.sh .build/release/SpeakApp

      - name: Report Coverage
        if: always()
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find "$BIN_PATH" -name '*.xctest' -type d | head -1)
          if [ -n "$XCTEST_PATH" ]; then
            EXEC_PATH="$XCTEST_PATH/Contents/MacOS/$(basename "$XCTEST_PATH" .xctest)"
            COV_DIR=$(swift test --show-codecov-path 2>/dev/null || echo "")
            if [ -n "$COV_DIR" ] && [ -f "$COV_DIR" ]; then
              echo "### Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
              xcrun llvm-cov report "$EXEC_PATH" \
                --instr-profile="$(dirname "$COV_DIR")/default.profdata" \
                --ignore-filename-regex='\.build|Tests/' 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY || true
            fi
          fi

  build-ios:
    name: Build iOS Library
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Build iOS Library
        run: swift build --target SpeakiOSLib

      - name: Test SpeakCore (iOS Simulator)
        run: |
          xcodebuild test \
            -scheme SpeakCore \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -skipPackagePluginValidation \
            -quiet \
            2>&1 | tail -20

  lint:
    name: Lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: SwiftLint
        run: |
          swift package plugin --allow-writing-to-package-directory swiftlint --strict --baseline .swiftlint-baseline.json
